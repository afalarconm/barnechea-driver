name: Monitor 24/7 Lo Barnechea

on:
  schedule:
    # Safety net: restarts the loop every hour in case of a GitHub runner failure or relay issue
    - cron: "0 * * * *"
  workflow_dispatch:      # Allows you to start it manually the first time

# Permissions needed for the runner to trigger the next "Relay"
permissions:
  actions: write
  contents: read

# Ensures only one runner is active at a time
concurrency:
  group: monitor-lobarnechea
  cancel-in-progress: false

jobs:
  poll-api:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: 20-Minute Monitoring Loop
        env:
          # --- Your App Config ---
          SALTALA_BASE: https://saltala.apisaltala.com/api/v1
          PUBLIC_URL: lobarnechea
          TARGET_LINE_NAMES: Renovación
          FALLBACK_LINE_ID: "1768"
          UNIT_HINT: "277"
          NUMBER_OF_MONTH: "2"
          
          # --- Secrets ---
          KAPSO_API_KEY: ${{ secrets.KAPSO_API_KEY }}
          KAPSO_PHONE_NUMBER_ID: ${{ secrets.KAPSO_PHONE_NUMBER_ID }}
          DEBUG_LOG_PAYLOADS: ${{ secrets.DEBUG_LOG_PAYLOADS }}
          
          # --- Relay Token ---
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          START_TS=$(date +%s)
          RUNTIME=1140 # 19 minutes
          SLEEP_TIME=60 # Check every 60 seconds
          TICK=0
          AVAILABILITY_FOUND=false
          
          echo "=========================================="
          echo "Starting monitoring window at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "Will run for ${RUNTIME}s, checking every ${SLEEP_TIME}s"
          echo "=========================================="
          
          while true; do
            TICK=$((TICK + 1))
            CURRENT_TIME=$(date -u +'%H:%M:%S')
            
            # 1. Run the checker
            echo "[${CURRENT_TIME} UTC] Poll #${TICK} - Checking availability..."
            python src/check_lobarnechea.py
            EXIT_CODE=$?
            # Exit code 42 means "availability was found and processed" (notify/booking).
            # In that case, stop early and hand off to the next relay run.
            if [ "${EXIT_CODE}" -eq 42 ]; then
              echo "[${CURRENT_TIME} UTC] ✅ Availability handled (exit 42). Stopping early for relay."
              AVAILABILITY_FOUND=true
              break
            elif [ "${EXIT_CODE}" -eq 0 ]; then
              echo "[${CURRENT_TIME} UTC] Poll #${TICK} completed successfully"
            else
              echo "::warning::Poll #${TICK} exited with code ${EXIT_CODE}, continuing..."
            fi
            
            # 2. Check if we've reached our time limit
            CURRENT_TS=$(date +%s)
            ELAPSED=$((CURRENT_TS - START_TS))
            REMAINING=$((RUNTIME - ELAPSED))
            
            if [ "$ELAPSED" -ge "$RUNTIME" ]; then
              echo "=========================================="
              echo "Target runtime reached (${ELAPSED}s). Preparing hand-off."
              echo "Completed ${TICK} polling cycles"
              echo "=========================================="
              break
            fi
            
            # Show progress
            if [ $((TICK % 5)) -eq 0 ]; then
              echo "[Progress] ${ELAPSED}s elapsed, ~${REMAINING}s remaining"
            fi
            
            # 3. Wait for the next tick
            sleep "$SLEEP_TIME"
          done
          
          # Exit with 0 if availability was found (exit code 42), so GitHub Actions doesn't mark it as an error
          if [ "$AVAILABILITY_FOUND" = "true" ]; then
            exit 0
          fi

      - name: Trigger next relay run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering the next relay run..."
          if gh workflow run "Monitor 24/7 Lo Barnechea" 2>&1; then
            echo "✅ Successfully triggered next monitoring cycle"
          else
            EXIT_CODE=$?
            echo "::error::Failed to trigger relay (exit code: ${EXIT_CODE})"
            echo "::warning::Hourly cron will restart monitoring at the next hour"
            exit $EXIT_CODE
          fi
